// src/prisma/schema.prisma

generator client {
  provider      = "prisma-client"
  engineType    = "client"
  output        = "./generated"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
}

// --------------------------------------------------------
// 1. GENERIC CACHE (Fallback)
// --------------------------------------------------------
model Cache {
  key       String   @id
  data      Json
  expireAt  DateTime
  createdAt DateTime @default(now())

  @@index([expireAt])
}

// --------------------------------------------------------
// 2. MOVIES (TMDB)
// --------------------------------------------------------
model TmdbMovieList {
  category    String   @id // e.g. "popular", "now_playing"
  
  movieIds    Int[]    // Order matters! [550, 123, 999...]
  
  // For lists like "Now Playing" that have date ranges
  minDate     String?  // e.g. "2025-11-12"
  maxDate     String?  // e.g. "2025-12-24"
  
  cachedAt    DateTime @default(now())
  expireAt    DateTime // Short TTL (e.g. 1 day)
}

// --- UPDATED: Movie Details ---
model TmdbMovie {
  id           Int      @id
  title        String
  overview     String?  @db.Text
  
  // Media
  posterPath   String?
  backdropPath String?
  
  // Metadata
  mediaType    String   @default("movie")
  releaseDate  DateTime?
  originalLang String?
  originalTitle String?
  
  // Rich Details (From Detail API)
  tagline      String?
  runtime      Int?
  status       String?
  imdbId       String?
  homepage     String?
  budget       BigInt?   @default(0) // New
  revenue      BigInt?   @default(0) // New
  
  // Ratings
  voteAverage  Float    @default(0)
  voteCount    Int      @default(0)
  popularity   Float    @default(0)
  
  genres       String[] 

  cachedAt     DateTime @default(now())
  expireAt     DateTime // Long TTL (e.g. 1 Year)

  @@index([expireAt])
}

// --------------------------------------------------------
// 3. NEWS ARTICLES
// --------------------------------------------------------
model NewsArticleList {
  category    String   @id // feed key, e.g. "general", "technology"
  articleIds  String[] // ordered article IDs

  cachedAt    DateTime @default(now())
  expireAt    DateTime
}

model NewsArticle {
  id          String   @id
  url         String   @unique

  title       String
  description String?  @db.Text
  content     String?  @db.Text

  source      Json
  author      String?
  imageUrl    String?

  publishedAt DateTime
  categories  String[] // MULTI-CATEGORY SUPPORT

  cachedAt    DateTime @default(now())
  expireAt    DateTime

  @@index([publishedAt(sort: Desc)])
  @@index([expireAt])
}

// --------------------------------------------------------
// 4. MUSIC TRACKS (Freesound / Jamendo)
// --------------------------------------------------------
model MusicTrack {
  uniqueId    String   @id 
  externalId  String
  provider    String   // "jamendo" | "freesound"
  
  title       String
  artist      String?
  album       String?
  
  streamUrl   String
  coverUrl    String?
  waveformUrl String?
  
  duration    Float?
  tags        String[]
  license     String?
  
  rating      Float?
  downloads   Int      @default(0)
  
  cachedAt    DateTime @default(now())
  expireAt    DateTime

  @@index([provider, tags])
  @@index([expireAt])
}

// --------------------------------------------------------
// 5. CODE SNIPPETS (Portfolio)
// --------------------------------------------------------
model CodeSnippet {
  // ID: constructed as "{language}-{slugified-title}" e.g., "go-worker-pool"
  slug        String   @id 
  
  navTitle    String   // Short name for Sidebar (e.g. "Worker Pool")
  title       String   // Full Title from README (e.g. "Go Concurrency Patterns")
  language    String   // "go" | "python"
  
  description String   @db.Text
  code        String   @db.Text
  
  order       Int      @default(0)
  
  // Optimization: Track which commit this version came from
  commitSha   String?  
  
  cachedAt    DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([language]) // Fast filtering for sidebar buckets
}

// --------------------------------------------------------
// 6. SYSTEM STATE (For Sync Optimization)
// --------------------------------------------------------
model SystemState {
  key         String   @id // e.g., "sandbox_repo_sha"
  value       String   // e.g., "a1b2c3d4..."
  lastSyncAt  DateTime @updatedAt
}